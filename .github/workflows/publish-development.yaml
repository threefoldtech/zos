name: Release (development)
on:
  push:
    branches:
      - "*"
    tags-ignore:
      - v*

jobs:
  build:
    name: Build and upload
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go 1.21
        uses: actions/setup-go@v1
        with:
          go-version: 1.21
        id: go

      - name: Checkout code into the Go module directory
        uses: actions/checkout@v1

      - name: Build binaries
        run: |
          go generate ./pkg/capacity/...
          cd cmds
          make
        env:
          GO111MODULE: on

      - name: Collecting files
        run: |
          scripts/collect.sh ${{ github.workspace }}/archive

      - name: Publish flist (${{ github.sha }})
        if: success()
        uses: threefoldtech/publish-flist@master
        with:
          token: ${{ secrets.HUB_JWT }}
          action: publish
          user: tf-autobuilder
          root: archive
          name: zos-${{ github.sha }}.flist

      - name: Tagging
        uses: threefoldtech/publish-flist@master
        with:
          token: ${{ secrets.HUB_JWT }}
          action: tag
          user: tf-autobuilder
          name: ${{ github.sha }}/zos.flist
          target: zos-${{ github.sha }}.flist

      - name: Cross tagging (development)
        if: success() && github.ref == 'refs/heads/main'
        uses: threefoldtech/publish-flist@master
        with:
          token: ${{ secrets.HUB_JWT }}
          action: crosstag
          user: tf-zos
          name: development
          target: tf-autobuilder/${{ github.sha }}
